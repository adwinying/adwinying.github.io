<!DOCTYPE html>
<html lang="en">
<head>
  <title>Integrating the New Sesame Lock with Home Assistant - iAdwin</title>

<link rel="canonical" href="https://iadw.in/integrating-the-new-sesame-lock-with-home-assistant/">

<meta name="description" content="After putting it off for a year and a half, I finally added Sesame Lock to Home Assistant.">

<meta name="robots" content="index, follow">

<meta property="og:title" content="Integrating the New Sesame Lock with Home Assistant">
<meta property="og:type" content="article">
<meta property="og:image" content="https://iadw.in/img/social.jpg">
<meta property="og:url" content="https://iadw.in/integrating-the-new-sesame-lock-with-home-assistant/">


<meta property="og:description" content="After putting it off for a year and a half, I finally added Sesame Lock to Home Assistant.">






<meta property="og:image:url" content="https://iadw.in/img/social.jpg">



<meta property="og:image:height">
<meta property="og:image:alt" content="Integrating the New Sesame Lock with Home Assistant">


<meta name="twitter:card" content="summary_large_image">




<meta content="width=device-width, initial-scale=1.0" name="viewport"><meta content="Adwin Ying" name="author">


  <meta charSet="UTF-8"/><meta name="theme-color" content="#ffffff"/><link rel="icon" href="/favicon.svg"/><link rel="mask-icon" href="/mask-icon.svg" color="#000000"/><link rel="apple-touch-icon" href="/apple-touch-icon.png"/><link rel="manifest" href="/manifest.json"/><link rel="preconnect" href="https://fonts.googleapis.com"/><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"/><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,500;1,500&amp;family=Open+Sans:ital,wght@0,300;0,400;0,700;1,400;1,700&amp;display=swap"/><script async="" defer="" data-website-id="5defccd5-b1c2-4556-8635-cfd36e168899" src="https://u.iadw.in/bundle.js"></script>

  
<link rel="stylesheet" href="/assets/404-_slug_-blog-index-tag-_tag_.e5d1e939.css" /></head>

<body class="flex flex-col bg-gray-50 min-h-screen ">
  <header class="container mx-auto flex items-center space-x-3 px-5 py-7"><a href="/" class="font-title text-3xl tracking-wider" aria-label="iAdwin">iA</a><span class="h-9 border-r-[2.5px] border-black"></span><a href="/blog" class="font-sans text-3xl font-normal text-gray-900">Blog</a><a href="/blog/rss.xml" target="_parent"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" class="mt-1 h-5"><path fill="currentColor" d="M128.081 415.959c0 35.369-28.672 64.041-64.041 64.041S0 451.328 0 415.959s28.672-64.041 64.041-64.041 64.04 28.673 64.04 64.041zm175.66 47.25c-8.354-154.6-132.185-278.587-286.95-286.95C7.656 175.765 0 183.105 0 192.253v48.069c0 8.415 6.49 15.472 14.887 16.018 111.832 7.284 201.473 96.702 208.772 208.772.547 8.397 7.604 14.887 16.018 14.887h48.069c9.149.001 16.489-7.655 15.995-16.79zm144.249.288C439.596 229.677 251.465 40.445 16.503 32.01 7.473 31.686 0 38.981 0 48.016v48.068c0 8.625 6.835 15.645 15.453 15.999 191.179 7.839 344.627 161.316 352.465 352.465.353 8.618 7.373 15.453 15.999 15.453h48.068c9.034-.001 16.329-7.474 16.005-16.504z"></path></svg></a></header><article class="mx-auto w-full max-w-blog p-5 pb-9"><div class="mb-8 font-sans"><h1 class="mb-1 text-5xl font-bold text-gray-900">Integrating the New Sesame Lock with Home Assistant</h1><span class="inline-block text-sm text-gray-600">10 Oct 2022<!-- --> | <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="mr-1 inline-block h-2.5"><path fill="currentColor" d="M0 252.118V48C0 21.49 21.49 0 48 0h204.118a48 48 0 0 1 33.941 14.059l211.882 211.882c18.745 18.745 18.745 49.137 0 67.882L293.823 497.941c-18.745 18.745-49.137 18.745-67.882 0L14.059 286.059A48 48 0 0 1 0 252.118zM112 64c-26.51 0-48 21.49-48 48s21.49 48 48 48 48-21.49 48-48-21.49-48-48-48z"></path></svg><a href="/tag/home-assistant/" class="text-sm text-gray-600 underline-offset-1 hover:underline ">home-assistant</a>, <a href="/tag/sesame-lock/" class="text-sm text-gray-600 underline-offset-1 hover:underline ">sesame-lock</a>, <a href="/tag/python/" class="text-sm text-gray-600 underline-offset-1 hover:underline ">python</a></span></div><div class="prose prose-lg max-w-none font-serif
          prose-headings:font-sans prose-figcaption:text-center
          prose-figcaption:font-sans prose-figcaption:text-sm"><p>I've been using <a href="https://jp.candyhouse.co/products/sesame4">Sesame Lock</a> for the past 1.5 years. At around ￥10,000 which also includes the Wifi Module and Sesame Bot (IoT button), it is a great option for those interested in a smart lock without breaking the bank. In addition, one could control it with a web API, opening up possibilities to integrate with any setup.</p>
<p>While I relied on iOS shortcuts to unlock my doors, I came across a great post by Tats Shibata on <a href="https://rewse.jp/blog/control-sesame-home-assistant/">how to integrate the new Sesame Locks with Home Assistant</a>. As the official Home Assistant integration only support models before Sesame 3, it took some effort to make the new Sesame locks work with Home Assistant.</p>
<h2 id="obtaining-api-key-device-uuid-and-secret-key">Obtaining API key, Device UUID and Secret Key</h2>
<p>The easiest way to integrate Sesame into Home Assistant is via their web API. Do note the web API is only free up to 30,000 calls a month, which I think is sufficient for day-to-day use. There are libraries such as <a href="https://github.com/mochipon/pysesameos2">pysesameos2</a> that controls Sesame via Bluetooth communication, but I won't be exploring these method for now.</p>
<p>To obtain an API key, go to <a href="https://partners.candyhouse.co/">Sesame API portal</a> and login with the email that you used to login into the mobile app.</p>
<figure><img src="/uploads/sesame-api-portal.jpg" alt="Sesame API Portal"><figcaption>Sesame API portal</figcaption></figure>
<p>In the API portal, click on the user icon circled in red. You'll see your devices appear on the right. You might need to click on the icon a couple of times for all of the devices that you own to appear. Then, click on the device that you want to control. The device UUID and secret key fields will be populated. Add these values to your <code>secrets.yaml</code> file.</p>
<figure><pre is:raw="" class="astro-code" style="background-color: #2e3440ff; overflow-x: auto;"><code><span class="line"><span style="color: #8FBCBB">sesame_api_key</span><span style="color: #ECEFF4">:</span><span style="color: #D8DEE9FF"> </span><span style="color: #ECEFF4">[</span><span style="color: #A3BE8C">api_key</span><span style="color: #ECEFF4">]</span></span>
<span class="line"><span style="color: #8FBCBB">sesame_device_uuid</span><span style="color: #ECEFF4">:</span><span style="color: #D8DEE9FF"> </span><span style="color: #ECEFF4">[</span><span style="color: #A3BE8C">device_uuid</span><span style="color: #ECEFF4">]</span></span>
<span class="line"><span style="color: #8FBCBB">sesame_device_secret</span><span style="color: #ECEFF4">:</span><span style="color: #D8DEE9FF"> </span><span style="color: #ECEFF4">[</span><span style="color: #A3BE8C">secret_key</span><span style="color: #ECEFF4">]</span></span></code></pre><figcaption>secrets.yaml</figcaption></figure>
<h2 id="getting-device-status">Getting Device Status</h2>
<p>Getting the device status is as easy as issuing a HTTP GET request:</p>
<pre is:raw="" class="astro-code" style="background-color: #2e3440ff; overflow-x: auto;"><code><span class="line"><span style="color: #D8DEE9FF">$ curl -s -H </span><span style="color: #ECEFF4">"</span><span style="color: #A3BE8C">x-api-key: </span><span style="color: #81A1C1">$</span><span style="color: #D8DEE9">API_KEY</span><span style="color: #ECEFF4">"</span><span style="color: #D8DEE9FF"> https://app.candyhouse.co/api/sesame2/</span><span style="color: #81A1C1">$</span><span style="color: #D8DEE9">DEVICE_UUID</span><span style="color: #D8DEE9FF"> </span><span style="color: #81A1C1">|</span><span style="color: #D8DEE9FF"> jq</span></span>
<span class="line"><span style="color: #ECEFF4">{</span></span>
<span class="line"><span style="color: #D8DEE9FF">  </span><span style="color: #ECEFF4">"</span><span style="color: #A3BE8C">batteryPercentage</span><span style="color: #ECEFF4">"</span><span style="color: #D8DEE9FF">: 100,</span></span>
<span class="line"><span style="color: #D8DEE9FF">  </span><span style="color: #ECEFF4">"</span><span style="color: #A3BE8C">batteryVoltage</span><span style="color: #ECEFF4">"</span><span style="color: #D8DEE9FF">: 6.003519061583578,</span></span>
<span class="line"><span style="color: #D8DEE9FF">  </span><span style="color: #ECEFF4">"</span><span style="color: #A3BE8C">position</span><span style="color: #ECEFF4">"</span><span style="color: #D8DEE9FF">: 479,</span></span>
<span class="line"><span style="color: #D8DEE9FF">  </span><span style="color: #ECEFF4">"</span><span style="color: #A3BE8C">CHSesame2Status</span><span style="color: #ECEFF4">"</span><span style="color: #D8DEE9FF">: </span><span style="color: #ECEFF4">"</span><span style="color: #A3BE8C">locked</span><span style="color: #ECEFF4">"</span><span style="color: #D8DEE9FF">,</span></span>
<span class="line"><span style="color: #D8DEE9FF">  </span><span style="color: #ECEFF4">"</span><span style="color: #A3BE8C">timestamp</span><span style="color: #ECEFF4">"</span><span style="color: #D8DEE9FF">: 1642253725,</span></span>
<span class="line"><span style="color: #D8DEE9FF">  </span><span style="color: #ECEFF4">"</span><span style="color: #A3BE8C">wm2State</span><span style="color: #ECEFF4">"</span><span style="color: #D8DEE9FF">: </span><span style="color: #88C0D0">true</span></span>
<span class="line"><span style="color: #ECEFF4">}</span></span></code></pre>
<p>You can integrate the status into a Home Assistant sensor using the <a href="https://www.home-assistant.io/integrations/sensor.rest/">RESTful Sensor integration</a>:</p>
<figure><pre is:raw="" class="astro-code" style="background-color: #2e3440ff; overflow-x: auto;"><code><span class="line"><span style="color: #616E88"># you can't use secrets directly in a template string hence this workaround</span></span>
<span class="line"><span style="color: #8FBCBB">input_text</span><span style="color: #ECEFF4">:</span></span>
<span class="line"><span style="color: #D8DEE9FF">  </span><span style="color: #8FBCBB">sesame_device_uuid</span><span style="color: #ECEFF4">:</span></span>
<span class="line"><span style="color: #D8DEE9FF">    </span><span style="color: #8FBCBB">initial</span><span style="color: #ECEFF4">:</span><span style="color: #D8DEE9FF"> </span><span style="color: #81A1C1">!secret</span><span style="color: #D8DEE9FF"> </span><span style="color: #A3BE8C">sesame_device_uuid</span></span>
<span class="line"></span>
<span class="line"><span style="color: #8FBCBB">sensor</span><span style="color: #ECEFF4">:</span></span>
<span class="line"><span style="color: #D8DEE9FF">  </span><span style="color: #ECEFF4">-</span><span style="color: #D8DEE9FF"> </span><span style="color: #8FBCBB">platform</span><span style="color: #ECEFF4">:</span><span style="color: #D8DEE9FF"> </span><span style="color: #A3BE8C">rest</span></span>
<span class="line"><span style="color: #D8DEE9FF">    </span><span style="color: #8FBCBB">name</span><span style="color: #ECEFF4">:</span><span style="color: #D8DEE9FF"> </span><span style="color: #A3BE8C">Sesame Lock Sensor</span></span>
<span class="line"><span style="color: #ECEFF4">    </span><span style="color: #616E88"># Adjust the scan interval so you don't get rate limited</span></span>
<span class="line"><span style="color: #D8DEE9FF">    </span><span style="color: #8FBCBB">scan_interval</span><span style="color: #ECEFF4">:</span><span style="color: #D8DEE9FF"> </span><span style="color: #B48EAD">600</span></span>
<span class="line"><span style="color: #D8DEE9FF">    </span><span style="color: #8FBCBB">method</span><span style="color: #ECEFF4">:</span><span style="color: #D8DEE9FF"> </span><span style="color: #A3BE8C">GET</span></span>
<span class="line"><span style="color: #D8DEE9FF">    </span><span style="color: #8FBCBB">headers</span><span style="color: #ECEFF4">:</span></span>
<span class="line"><span style="color: #D8DEE9FF">      </span><span style="color: #8FBCBB">x-api-key</span><span style="color: #ECEFF4">:</span><span style="color: #D8DEE9FF"> </span><span style="color: #81A1C1">!secret</span><span style="color: #D8DEE9FF"> </span><span style="color: #A3BE8C">sesame_api_key</span></span>
<span class="line"><span style="color: #D8DEE9FF">    </span><span style="color: #8FBCBB">resource_template</span><span style="color: #ECEFF4">:</span><span style="color: #D8DEE9FF"> </span><span style="color: #ECEFF4">"</span><span style="color: #A3BE8C">https://app.candyhouse.co/api/sesame2/{{ states('input_text.sesame_device_uuid') }}</span><span style="color: #ECEFF4">"</span></span>
<span class="line"><span style="color: #D8DEE9FF">    </span><span style="color: #8FBCBB">value_template</span><span style="color: #ECEFF4">:</span><span style="color: #D8DEE9FF"> </span><span style="color: #ECEFF4">'</span><span style="color: #A3BE8C">{{ value_json.CHSesame2Status }}</span><span style="color: #ECEFF4">'</span></span>
<span class="line"><span style="color: #D8DEE9FF">    </span><span style="color: #8FBCBB">json_attributes</span><span style="color: #ECEFF4">:</span></span>
<span class="line"><span style="color: #D8DEE9FF">      </span><span style="color: #ECEFF4">-</span><span style="color: #D8DEE9FF"> </span><span style="color: #A3BE8C">batteryPercentage</span></span>
<span class="line"><span style="color: #D8DEE9FF">      </span><span style="color: #ECEFF4">-</span><span style="color: #D8DEE9FF"> </span><span style="color: #A3BE8C">batteryVoltage</span></span>
<span class="line"><span style="color: #D8DEE9FF">      </span><span style="color: #ECEFF4">-</span><span style="color: #D8DEE9FF"> </span><span style="color: #A3BE8C">position</span></span>
<span class="line"><span style="color: #D8DEE9FF">      </span><span style="color: #ECEFF4">-</span><span style="color: #D8DEE9FF"> </span><span style="color: #A3BE8C">CHSesame2Status</span></span>
<span class="line"><span style="color: #D8DEE9FF">      </span><span style="color: #ECEFF4">-</span><span style="color: #D8DEE9FF"> </span><span style="color: #A3BE8C">timestamp</span></span></code></pre><figcaption>Sesame Lock sensor config</figcaption></figure>
<h2 id="sending-commands-to-the-device">Sending Commands to the Device</h2>
<p>Unfortunately sending commands to the device is not as easy as getting the status. The secret key needs to be encrypted before sending, which is not achievable via the YAML config. Home Assistant's <a href="https://www.home-assistant.io/integrations/python_script/">Python Script integration</a> isn't good enough as you'll need to import modules to encrypt the secret key. But it is simple enough to make a standalone script like so:</p>
<figure><pre is:raw="" class="astro-code" style="background-color: #2e3440ff; overflow-x: auto;"><code><span class="line"><span style="color: #616E88">#!/usr/bin/env python3</span></span>
<span class="line"></span>
<span class="line"><span style="color: #81A1C1">import</span><span style="color: #D8DEE9FF"> base64</span><span style="color: #ECEFF4">,</span><span style="color: #D8DEE9FF"> datetime</span><span style="color: #ECEFF4">,</span><span style="color: #D8DEE9FF"> json</span><span style="color: #ECEFF4">,</span><span style="color: #D8DEE9FF"> requests</span><span style="color: #ECEFF4">,</span><span style="color: #D8DEE9FF"> sys</span></span>
<span class="line"><span style="color: #81A1C1">from</span><span style="color: #D8DEE9FF"> Crypto</span><span style="color: #ECEFF4">.</span><span style="color: #D8DEE9FF">Cipher </span><span style="color: #81A1C1">import</span><span style="color: #D8DEE9FF"> AES</span></span>
<span class="line"><span style="color: #81A1C1">from</span><span style="color: #D8DEE9FF"> Crypto</span><span style="color: #ECEFF4">.</span><span style="color: #D8DEE9FF">Hash </span><span style="color: #81A1C1">import</span><span style="color: #D8DEE9FF"> CMAC</span></span>
<span class="line"></span>
<span class="line"><span style="color: #D8DEE9FF">COMMANDS </span><span style="color: #81A1C1">=</span><span style="color: #D8DEE9FF"> </span><span style="color: #ECEFF4">{</span></span>
<span class="line"><span style="color: #D8DEE9FF">    </span><span style="color: #ECEFF4">"</span><span style="color: #A3BE8C">lock</span><span style="color: #ECEFF4">"</span><span style="color: #ECEFF4">:</span><span style="color: #D8DEE9FF"> </span><span style="color: #B48EAD">82</span><span style="color: #ECEFF4">,</span></span>
<span class="line"><span style="color: #D8DEE9FF">    </span><span style="color: #ECEFF4">"</span><span style="color: #A3BE8C">unlock</span><span style="color: #ECEFF4">"</span><span style="color: #ECEFF4">:</span><span style="color: #D8DEE9FF"> </span><span style="color: #B48EAD">83</span><span style="color: #ECEFF4">,</span></span>
<span class="line"><span style="color: #D8DEE9FF">    </span><span style="color: #ECEFF4">"</span><span style="color: #A3BE8C">toggle</span><span style="color: #ECEFF4">"</span><span style="color: #ECEFF4">:</span><span style="color: #D8DEE9FF"> </span><span style="color: #B48EAD">88</span><span style="color: #ECEFF4">,</span></span>
<span class="line"><span style="color: #ECEFF4">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #81A1C1">def</span><span style="color: #D8DEE9FF"> </span><span style="color: #88C0D0">main</span><span style="color: #ECEFF4">():</span></span>
<span class="line"><span style="color: #D8DEE9FF">    </span><span style="color: #81A1C1">try</span><span style="color: #ECEFF4">:</span></span>
<span class="line"><span style="color: #D8DEE9FF">        command </span><span style="color: #81A1C1">=</span><span style="color: #D8DEE9FF"> sys</span><span style="color: #ECEFF4">.</span><span style="color: #D8DEE9FF">argv</span><span style="color: #ECEFF4">[</span><span style="color: #B48EAD">1</span><span style="color: #ECEFF4">]</span></span>
<span class="line"><span style="color: #D8DEE9FF">        api_key </span><span style="color: #81A1C1">=</span><span style="color: #D8DEE9FF"> sys</span><span style="color: #ECEFF4">.</span><span style="color: #D8DEE9FF">argv</span><span style="color: #ECEFF4">[</span><span style="color: #B48EAD">2</span><span style="color: #ECEFF4">]</span></span>
<span class="line"><span style="color: #D8DEE9FF">        uuid </span><span style="color: #81A1C1">=</span><span style="color: #D8DEE9FF"> sys</span><span style="color: #ECEFF4">.</span><span style="color: #D8DEE9FF">argv</span><span style="color: #ECEFF4">[</span><span style="color: #B48EAD">3</span><span style="color: #ECEFF4">]</span></span>
<span class="line"><span style="color: #D8DEE9FF">        secret </span><span style="color: #81A1C1">=</span><span style="color: #D8DEE9FF"> sys</span><span style="color: #ECEFF4">.</span><span style="color: #D8DEE9FF">argv</span><span style="color: #ECEFF4">[</span><span style="color: #B48EAD">4</span><span style="color: #ECEFF4">]</span></span>
<span class="line"><span style="color: #D8DEE9FF">    </span><span style="color: #81A1C1">except</span><span style="color: #D8DEE9FF"> </span><span style="color: #8FBCBB">IndexError</span><span style="color: #ECEFF4">:</span></span>
<span class="line"><span style="color: #D8DEE9FF">        </span><span style="color: #88C0D0">print</span><span style="color: #ECEFF4">(</span><span style="color: #ECEFF4">"</span><span style="color: #A3BE8C">Usage: sesame &#x3C;lock|unlock|toggle> &#x3C;api_key> &#x3C;uuid> &#x3C;secret></span><span style="color: #ECEFF4">"</span><span style="color: #ECEFF4">)</span></span>
<span class="line"><span style="color: #D8DEE9FF">        sys</span><span style="color: #ECEFF4">.</span><span style="color: #88C0D0">exit</span><span style="color: #ECEFF4">(</span><span style="color: #B48EAD">1</span><span style="color: #ECEFF4">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #D8DEE9FF">    cmd </span><span style="color: #81A1C1">=</span><span style="color: #D8DEE9FF"> COMMANDS</span><span style="color: #ECEFF4">[</span><span style="color: #D8DEE9FF">command</span><span style="color: #ECEFF4">]</span></span>
<span class="line"></span>
<span class="line"><span style="color: #D8DEE9FF">    history </span><span style="color: #81A1C1">=</span><span style="color: #D8DEE9FF"> base64</span><span style="color: #ECEFF4">.</span><span style="color: #88C0D0">b64encode</span><span style="color: #ECEFF4">(</span><span style="color: #ECEFF4">"</span><span style="color: #A3BE8C">HomeAssistant</span><span style="color: #ECEFF4">"</span><span style="color: #ECEFF4">.</span><span style="color: #88C0D0">encode</span><span style="color: #ECEFF4">()).</span><span style="color: #88C0D0">decode</span><span style="color: #ECEFF4">()</span></span>
<span class="line"></span>
<span class="line"><span style="color: #D8DEE9FF">    ts </span><span style="color: #81A1C1">=</span><span style="color: #D8DEE9FF"> </span><span style="color: #88C0D0">int</span><span style="color: #ECEFF4">(</span><span style="color: #D8DEE9FF">datetime</span><span style="color: #ECEFF4">.</span><span style="color: #D8DEE9FF">datetime</span><span style="color: #ECEFF4">.</span><span style="color: #88C0D0">now</span><span style="color: #ECEFF4">().</span><span style="color: #88C0D0">timestamp</span><span style="color: #ECEFF4">())</span></span>
<span class="line"><span style="color: #D8DEE9FF">    msg </span><span style="color: #81A1C1">=</span><span style="color: #D8DEE9FF"> ts</span><span style="color: #ECEFF4">.</span><span style="color: #88C0D0">to_bytes</span><span style="color: #ECEFF4">(</span><span style="color: #B48EAD">4</span><span style="color: #ECEFF4">,</span><span style="color: #D8DEE9FF"> </span><span style="color: #D8DEE9">byteorder</span><span style="color: #81A1C1">=</span><span style="color: #ECEFF4">"</span><span style="color: #A3BE8C">little</span><span style="color: #ECEFF4">"</span><span style="color: #ECEFF4">).</span><span style="color: #88C0D0">hex</span><span style="color: #ECEFF4">()[</span><span style="color: #B48EAD">2</span><span style="color: #ECEFF4">:</span><span style="color: #B48EAD">8</span><span style="color: #ECEFF4">]</span></span>
<span class="line"></span>
<span class="line"><span style="color: #D8DEE9FF">    cmac </span><span style="color: #81A1C1">=</span><span style="color: #D8DEE9FF"> CMAC</span><span style="color: #ECEFF4">.</span><span style="color: #88C0D0">new</span><span style="color: #ECEFF4">(</span><span style="color: #88C0D0">bytes</span><span style="color: #ECEFF4">.</span><span style="color: #88C0D0">fromhex</span><span style="color: #ECEFF4">(</span><span style="color: #D8DEE9FF">secret</span><span style="color: #ECEFF4">),</span><span style="color: #D8DEE9FF"> </span><span style="color: #D8DEE9">ciphermod</span><span style="color: #81A1C1">=</span><span style="color: #D8DEE9FF">AES</span><span style="color: #ECEFF4">)</span></span>
<span class="line"><span style="color: #D8DEE9FF">    cmac</span><span style="color: #ECEFF4">.</span><span style="color: #88C0D0">update</span><span style="color: #ECEFF4">(</span><span style="color: #88C0D0">bytes</span><span style="color: #ECEFF4">.</span><span style="color: #88C0D0">fromhex</span><span style="color: #ECEFF4">(</span><span style="color: #D8DEE9FF">msg</span><span style="color: #ECEFF4">))</span></span>
<span class="line"><span style="color: #D8DEE9FF">    sign </span><span style="color: #81A1C1">=</span><span style="color: #D8DEE9FF"> cmac</span><span style="color: #ECEFF4">.</span><span style="color: #88C0D0">hexdigest</span><span style="color: #ECEFF4">()</span></span>
<span class="line"></span>
<span class="line"><span style="color: #D8DEE9FF">    url </span><span style="color: #81A1C1">=</span><span style="color: #D8DEE9FF"> </span><span style="color: #81A1C1">f</span><span style="color: #A3BE8C">'https://app.candyhouse.co/api/sesame2/</span><span style="color: #EBCB8B">{</span><span style="color: #D8DEE9FF">uuid</span><span style="color: #EBCB8B">}</span><span style="color: #A3BE8C">/cmd'</span></span>
<span class="line"><span style="color: #D8DEE9FF">    headers </span><span style="color: #81A1C1">=</span><span style="color: #D8DEE9FF"> </span><span style="color: #ECEFF4">{</span><span style="color: #D8DEE9FF"> </span><span style="color: #ECEFF4">"</span><span style="color: #A3BE8C">x-api-key</span><span style="color: #ECEFF4">"</span><span style="color: #ECEFF4">:</span><span style="color: #D8DEE9FF"> api_key </span><span style="color: #ECEFF4">}</span></span>
<span class="line"><span style="color: #D8DEE9FF">    body </span><span style="color: #81A1C1">=</span><span style="color: #D8DEE9FF"> </span><span style="color: #ECEFF4">{</span><span style="color: #D8DEE9FF"> </span><span style="color: #ECEFF4">"</span><span style="color: #A3BE8C">cmd</span><span style="color: #ECEFF4">"</span><span style="color: #ECEFF4">:</span><span style="color: #D8DEE9FF"> cmd</span><span style="color: #ECEFF4">,</span><span style="color: #D8DEE9FF"> </span><span style="color: #ECEFF4">"</span><span style="color: #A3BE8C">history</span><span style="color: #ECEFF4">"</span><span style="color: #ECEFF4">:</span><span style="color: #D8DEE9FF"> history</span><span style="color: #ECEFF4">,</span><span style="color: #D8DEE9FF"> </span><span style="color: #ECEFF4">"</span><span style="color: #A3BE8C">sign</span><span style="color: #ECEFF4">"</span><span style="color: #ECEFF4">:</span><span style="color: #D8DEE9FF"> sign </span><span style="color: #ECEFF4">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #D8DEE9FF">    res </span><span style="color: #81A1C1">=</span><span style="color: #D8DEE9FF"> requests</span><span style="color: #ECEFF4">.</span><span style="color: #88C0D0">post</span><span style="color: #ECEFF4">(</span><span style="color: #D8DEE9FF">url</span><span style="color: #ECEFF4">,</span><span style="color: #D8DEE9FF"> json</span><span style="color: #ECEFF4">.</span><span style="color: #88C0D0">dumps</span><span style="color: #ECEFF4">(</span><span style="color: #D8DEE9FF">body</span><span style="color: #ECEFF4">),</span><span style="color: #D8DEE9FF"> </span><span style="color: #D8DEE9">headers</span><span style="color: #81A1C1">=</span><span style="color: #D8DEE9FF">headers</span><span style="color: #ECEFF4">)</span></span>
<span class="line"><span style="color: #D8DEE9FF">    </span><span style="color: #88C0D0">print</span><span style="color: #ECEFF4">(</span><span style="color: #D8DEE9FF">url</span><span style="color: #ECEFF4">,</span><span style="color: #D8DEE9FF"> headers</span><span style="color: #ECEFF4">,</span><span style="color: #D8DEE9FF"> body</span><span style="color: #ECEFF4">)</span></span>
<span class="line"><span style="color: #D8DEE9FF">    </span><span style="color: #88C0D0">print</span><span style="color: #ECEFF4">(</span><span style="color: #D8DEE9FF">res</span><span style="color: #ECEFF4">.</span><span style="color: #D8DEE9FF">status_code</span><span style="color: #ECEFF4">,</span><span style="color: #D8DEE9FF"> res</span><span style="color: #ECEFF4">.</span><span style="color: #D8DEE9FF">text</span><span style="color: #ECEFF4">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #81A1C1">if</span><span style="color: #D8DEE9FF"> __name__ </span><span style="color: #81A1C1">==</span><span style="color: #D8DEE9FF"> </span><span style="color: #ECEFF4">"</span><span style="color: #A3BE8C">__main__</span><span style="color: #ECEFF4">"</span><span style="color: #ECEFF4">:</span></span>
<span class="line"><span style="color: #D8DEE9FF">    </span><span style="color: #88C0D0">main</span><span style="color: #ECEFF4">()</span></span></code></pre><figcaption>sesame.py</figcaption></figure>
<p>Save this file somewhere in your Home Assistant config and make it executable:</p>
<pre is:raw="" class="astro-code" style="background-color: #2e3440ff; overflow-x: auto;"><code><span class="line"><span style="color: #D8DEE9FF">$ chmod +x sesame.py</span></span></code></pre>
<p>You can then call the script like so via the command line:</p>
<pre is:raw="" class="astro-code" style="background-color: #2e3440ff; overflow-x: auto;"><code><span class="line"><span style="color: #D8DEE9FF">$ /config/python_scripts/sesame.py </span><span style="color: #ECEFF4">[</span><span style="color: #D8DEE9FF">lock</span><span style="color: #81A1C1">|</span><span style="color: #D8DEE9FF">unlock</span><span style="color: #81A1C1">|</span><span style="color: #D8DEE9FF">toggle</span><span style="color: #ECEFF4">]</span><span style="color: #D8DEE9FF"> </span><span style="color: #81A1C1">$</span><span style="color: #D8DEE9">API_KEY</span><span style="color: #D8DEE9FF"> </span><span style="color: #81A1C1">$</span><span style="color: #D8DEE9">DEVICE_UUID</span><span style="color: #D8DEE9FF"> </span><span style="color: #81A1C1">$</span><span style="color: #D8DEE9">DEVICE_SECRET</span></span></code></pre>
<p>And here's how to integrate the commands into Home Assistant using the <a href="https://www.home-assistant.io/integrations/shell_command/">Shell Command integration</a>:</p>
<figure><pre is:raw="" class="astro-code" style="background-color: #2e3440ff; overflow-x: auto;"><code><span class="line"><span style="color: #8FBCBB">shell_command</span><span style="color: #ECEFF4">:</span></span>
<span class="line"><span style="color: #D8DEE9FF">  </span><span style="color: #8FBCBB">sesame</span><span style="color: #ECEFF4">:</span><span style="color: #D8DEE9FF"> </span><span style="color: #ECEFF4">"</span><span style="color: #A3BE8C">/config/python_scripts/sesame.py {{ command }} {{ api_key }} {{ uuid }} {{ secret }}</span><span style="color: #ECEFF4">"</span></span>
<span class="line"></span>
<span class="line"><span style="color: #8FBCBB">scripts</span><span style="color: #ECEFF4">:</span></span>
<span class="line"><span style="color: #D8DEE9FF">  </span><span style="color: #8FBCBB">lock_sesame</span><span style="color: #ECEFF4">:</span></span>
<span class="line"><span style="color: #D8DEE9FF">    </span><span style="color: #8FBCBB">sequence</span><span style="color: #ECEFF4">:</span></span>
<span class="line"><span style="color: #D8DEE9FF">      </span><span style="color: #ECEFF4">-</span><span style="color: #D8DEE9FF"> </span><span style="color: #8FBCBB">service</span><span style="color: #ECEFF4">:</span><span style="color: #D8DEE9FF"> </span><span style="color: #A3BE8C">shell_command.sesame</span></span>
<span class="line"><span style="color: #D8DEE9FF">        </span><span style="color: #8FBCBB">data_template</span><span style="color: #ECEFF4">:</span></span>
<span class="line"><span style="color: #D8DEE9FF">          </span><span style="color: #8FBCBB">command</span><span style="color: #ECEFF4">:</span><span style="color: #D8DEE9FF"> </span><span style="color: #A3BE8C">lock</span></span>
<span class="line"><span style="color: #D8DEE9FF">          </span><span style="color: #8FBCBB">api_key</span><span style="color: #ECEFF4">:</span><span style="color: #D8DEE9FF"> </span><span style="color: #81A1C1">!secret</span><span style="color: #D8DEE9FF"> </span><span style="color: #A3BE8C">sesame_api_key</span></span>
<span class="line"><span style="color: #D8DEE9FF">          </span><span style="color: #8FBCBB">uuid</span><span style="color: #ECEFF4">:</span><span style="color: #D8DEE9FF"> </span><span style="color: #81A1C1">!secret</span><span style="color: #D8DEE9FF"> </span><span style="color: #A3BE8C">sesame_device_uuid</span></span>
<span class="line"><span style="color: #D8DEE9FF">          </span><span style="color: #8FBCBB">secret</span><span style="color: #ECEFF4">:</span><span style="color: #D8DEE9FF"> </span><span style="color: #81A1C1">!secret</span><span style="color: #D8DEE9FF"> </span><span style="color: #A3BE8C">sesame_device_secret</span></span>
<span class="line"></span>
<span class="line"><span style="color: #D8DEE9FF">  </span><span style="color: #8FBCBB">unlock_sesame</span><span style="color: #ECEFF4">:</span></span>
<span class="line"><span style="color: #D8DEE9FF">    </span><span style="color: #8FBCBB">sequence</span><span style="color: #ECEFF4">:</span></span>
<span class="line"><span style="color: #D8DEE9FF">      </span><span style="color: #ECEFF4">-</span><span style="color: #D8DEE9FF"> </span><span style="color: #8FBCBB">service</span><span style="color: #ECEFF4">:</span><span style="color: #D8DEE9FF"> </span><span style="color: #A3BE8C">shell_command.sesame</span></span>
<span class="line"><span style="color: #D8DEE9FF">        </span><span style="color: #8FBCBB">data_template</span><span style="color: #ECEFF4">:</span></span>
<span class="line"><span style="color: #D8DEE9FF">          </span><span style="color: #8FBCBB">command</span><span style="color: #ECEFF4">:</span><span style="color: #D8DEE9FF"> </span><span style="color: #A3BE8C">unlock</span></span>
<span class="line"><span style="color: #D8DEE9FF">          </span><span style="color: #8FBCBB">api_key</span><span style="color: #ECEFF4">:</span><span style="color: #D8DEE9FF"> </span><span style="color: #81A1C1">!secret</span><span style="color: #D8DEE9FF"> </span><span style="color: #A3BE8C">sesame_api_key</span></span>
<span class="line"><span style="color: #D8DEE9FF">          </span><span style="color: #8FBCBB">uuid</span><span style="color: #ECEFF4">:</span><span style="color: #D8DEE9FF"> </span><span style="color: #81A1C1">!secret</span><span style="color: #D8DEE9FF"> </span><span style="color: #A3BE8C">sesame_device_uuid</span></span>
<span class="line"><span style="color: #D8DEE9FF">          </span><span style="color: #8FBCBB">secret</span><span style="color: #ECEFF4">:</span><span style="color: #D8DEE9FF"> </span><span style="color: #81A1C1">!secret</span><span style="color: #D8DEE9FF"> </span><span style="color: #A3BE8C">sesame_device_secret</span></span></code></pre><figcaption>Sesame Lock commands config</figcaption></figure>
<p>If all goes well, you should be able to invoke commands by using <code>scripts:lock_sesame</code> and <code>scripts:unlock_sesame</code> service.</p>
<h2 id="bringing-them-all-together-in-a-single-device">Bringing them all together in a single device</h2>
<p>We can finally combine the sensor and controls into a single entity using the <a href="https://www.home-assistant.io/integrations/lock.template/">Template Lock</a> integration:</p>
<figure><pre is:raw="" class="astro-code" style="background-color: #2e3440ff; overflow-x: auto;"><code><span class="line"><span style="color: #8FBCBB">lock</span><span style="color: #ECEFF4">:</span></span>
<span class="line"><span style="color: #D8DEE9FF">  </span><span style="color: #ECEFF4">-</span><span style="color: #D8DEE9FF"> </span><span style="color: #8FBCBB">platform</span><span style="color: #ECEFF4">:</span><span style="color: #D8DEE9FF"> </span><span style="color: #A3BE8C">template</span></span>
<span class="line"><span style="color: #D8DEE9FF">    </span><span style="color: #8FBCBB">name</span><span style="color: #ECEFF4">:</span><span style="color: #D8DEE9FF"> </span><span style="color: #A3BE8C">Sesame Lock</span></span>
<span class="line"><span style="color: #D8DEE9FF">    </span><span style="color: #8FBCBB">value_template</span><span style="color: #ECEFF4">:</span><span style="color: #D8DEE9FF"> </span><span style="color: #ECEFF4">"</span><span style="color: #A3BE8C">{{ is_state('sensor.sesame_lock_sensor', 'locked') }}</span><span style="color: #ECEFF4">"</span></span>
<span class="line"><span style="color: #D8DEE9FF">    </span><span style="color: #8FBCBB">lock</span><span style="color: #ECEFF4">:</span></span>
<span class="line"><span style="color: #D8DEE9FF">      </span><span style="color: #8FBCBB">service</span><span style="color: #ECEFF4">:</span><span style="color: #D8DEE9FF"> </span><span style="color: #A3BE8C">script.lock_sesame</span></span>
<span class="line"><span style="color: #D8DEE9FF">    </span><span style="color: #8FBCBB">unlock</span><span style="color: #ECEFF4">:</span></span>
<span class="line"><span style="color: #D8DEE9FF">      </span><span style="color: #8FBCBB">service</span><span style="color: #ECEFF4">:</span><span style="color: #D8DEE9FF"> </span><span style="color: #A3BE8C">script.unlock_sesame</span></span></code></pre><figcaption>Sesame Lock entity config</figcaption></figure>
<p>All done! You can now integrate the Sesame lock into your Home Assistant using <code>lock.sesame_lock</code>. My Sesame Lock config can be found in <a href="https://github.com/adwinying/homeassistant-config/commit/8cfdb15243c562783d3ce0f4e3f538e6f40da2e5">my Home Assistant config Github repository</a>.</p><hr/></div><div class="flex flex-col space-y-3 sm:flex-row sm:items-center sm:space-x-5 sm:space-y-0 mt-14 mb-9 font-sans text-base"><div class="w-28 sm:w-32"><img src="/img/avatar.png" srcSet="/assets/avatar@112w.377da505.png 112w, /assets/avatar@128w.9acea303.png 128w" alt="Adwin Ying&#x27;s avatar"/></div><div class="flex flex-1 flex-col space-y-1"><span class="text-2xl font-bold">Adwin Ying</span><p class="text-gray-800">Self-taught full-stack web dev based in Tokyo.<!-- --> <br class="hidden sm:block"/>Occasionally wrecks servers through <a class="text-sky-500 hover:text-sky-700 " href="https://www.reddit.com/r/selfhosted/">self-hosting</a> and <a class="text-sky-500 hover:text-sky-700 " href="https://www.reddit.com/r/homelab/">homelab-ing</a>.</p><div class="flex"><a class="text-sky-500 hover:text-sky-700 flex space-x-1" href="/"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="w-4"><path fill="currentColor" d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"></path></svg><span>https://iAdw.in</span></a></div></div></div><a class="text-sky-500 hover:text-sky-700 font-sans !text-gray-900 underline underline-offset-2" href="/blog">← Back to all posts</a></article><footer class="bg-black py-3 text-center text-gray-50">iAdwin © <!-- -->2023<!-- --> Adwin Ying.</footer>
</body></html>