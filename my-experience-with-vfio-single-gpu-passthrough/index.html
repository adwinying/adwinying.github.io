<!DOCTYPE html>
<html lang="en">
<head>
  <title>My Experience with VFIO + Single GPU Passthrough - iAdwin</title>

<link rel="canonical" href="https://iadw.in/my-experience-with-vfio-single-gpu-passthrough/">

<meta name="description" content="Summed up my experience setting up VFIO on an Arch Linux desktop.">

<meta name="robots" content="index, follow">

<meta property="og:title" content="My Experience with VFIO + Single GPU Passthrough">
<meta property="og:type" content="article">
<meta property="og:image" content="https://iadw.in/img/social.jpg">
<meta property="og:url" content="https://iadw.in/my-experience-with-vfio-single-gpu-passthrough/">


<meta property="og:description" content="Summed up my experience setting up VFIO on an Arch Linux desktop.">






<meta property="og:image:url" content="https://iadw.in/img/social.jpg">



<meta property="og:image:height">
<meta property="og:image:alt" content="My Experience with VFIO + Single GPU Passthrough">


<meta name="twitter:card" content="summary_large_image">




<meta content="width=device-width, initial-scale=1.0" name="viewport"><meta content="Adwin Ying" name="author">


  <meta charSet="UTF-8"/><meta name="theme-color" content="#ffffff"/><link rel="icon" href="/favicon.svg"/><link rel="mask-icon" href="/mask-icon.svg" color="#000000"/><link rel="apple-touch-icon" href="/apple-touch-icon.png"/><link rel="manifest" href="/manifest.json"/><link rel="preconnect" href="https://fonts.googleapis.com"/><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"/><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,500;1,500&amp;family=Open+Sans:ital,wght@0,300;0,400;0,700;1,400;1,700&amp;display=swap"/>

  
<link rel="stylesheet" href="/assets/404-_slug_-blog-index-tag-_tag_.e5d1e939.css" /></head>

<body class="flex flex-col bg-gray-50 min-h-screen ">
  <header class="container mx-auto flex items-center space-x-3 px-5 py-7"><a href="/" class="font-title text-3xl tracking-wider" aria-label="iAdwin">iA</a><span class="h-9 border-r-[2.5px] border-black"></span><a href="/blog" class="font-sans text-3xl font-normal text-gray-900">Blog</a><a href="/blog/rss.xml" target="_parent"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" class="mt-1 h-5"><path fill="currentColor" d="M128.081 415.959c0 35.369-28.672 64.041-64.041 64.041S0 451.328 0 415.959s28.672-64.041 64.041-64.041 64.04 28.673 64.04 64.041zm175.66 47.25c-8.354-154.6-132.185-278.587-286.95-286.95C7.656 175.765 0 183.105 0 192.253v48.069c0 8.415 6.49 15.472 14.887 16.018 111.832 7.284 201.473 96.702 208.772 208.772.547 8.397 7.604 14.887 16.018 14.887h48.069c9.149.001 16.489-7.655 15.995-16.79zm144.249.288C439.596 229.677 251.465 40.445 16.503 32.01 7.473 31.686 0 38.981 0 48.016v48.068c0 8.625 6.835 15.645 15.453 15.999 191.179 7.839 344.627 161.316 352.465 352.465.353 8.618 7.373 15.453 15.999 15.453h48.068c9.034-.001 16.329-7.474 16.005-16.504z"></path></svg></a></header><article class="mx-auto w-full max-w-blog p-5 pb-9"><div class="mb-8 font-sans"><h1 class="mb-1 text-5xl font-bold text-gray-900">My Experience with VFIO + Single GPU Passthrough</h1><span class="inline-block text-sm text-gray-600">06 Feb 2021<!-- --> | <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="mr-1 inline-block h-2.5"><path fill="currentColor" d="M0 252.118V48C0 21.49 21.49 0 48 0h204.118a48 48 0 0 1 33.941 14.059l211.882 211.882c18.745 18.745 18.745 49.137 0 67.882L293.823 497.941c-18.745 18.745-49.137 18.745-67.882 0L14.059 286.059A48 48 0 0 1 0 252.118zM112 64c-26.51 0-48 21.49-48 48s21.49 48 48 48 48-21.49 48-48-21.49-48-48-48z"></path></svg><a href="/tag/vfio" class="text-sm text-gray-600 underline-offset-1 hover:underline ">vfio</a>, <a href="/tag/vm" class="text-sm text-gray-600 underline-offset-1 hover:underline ">vm</a>, <a href="/tag/linux" class="text-sm text-gray-600 underline-offset-1 hover:underline ">linux</a>, <a href="/tag/macos" class="text-sm text-gray-600 underline-offset-1 hover:underline ">macos</a>, <a href="/tag/windows" class="text-sm text-gray-600 underline-offset-1 hover:underline ">windows</a>, <a href="/tag/pc" class="text-sm text-gray-600 underline-offset-1 hover:underline ">pc</a></span></div><div class="prose prose-lg max-w-none font-serif
          prose-headings:font-sans prose-figcaption:text-center
          prose-figcaption:font-sans prose-figcaption:text-sm"><h2 id="desktop-specs">Desktop Specs</h2>
<ul>
<li><strong>Processor:</strong> AMD Ryzen 7 3700X</li>
<li><strong>RAM:</strong> Klevv 2x16GB 3200MHz DDR4</li>
<li><strong>Motherboard:</strong> MSI microATX B550 Mortar WIFI</li>
<li><strong>GPU:</strong> Sapphire Pulse Radeon RX580 8GB</li>
<li><strong>SSD:</strong> Samsung 970EVO 1TB NVME</li>
<li><strong>HDD:</strong> Some Toshiba 2.5" 1TB ripped from my old laptop</li>
<li><strong>PSU:</strong> SilverStone SFX-L 80+ Gold 500W</li>
<li><strong>Host OS:</strong> Arch Linux with latest stable/LTS kernel</li>
<li><strong>Guest OS:</strong> Windows 10, macOS Big Sur</li>
</ul>
<h2 id="guides-used">Guides Used</h2>
<ul>
<li><a href="https://github.com/joeknock90/Single-GPU-Passthrough">joeknock90's Single GPU Passthrough Guide</a></li>
<li><a href="https://wiki.archlinux.org/index.php/PCI_passthrough_via_OVMF">ArchWiki's VFIO Guide</a></li>
</ul>
<h2 id="great-iommu-groups-on-this-motherboard">Great IOMMU groups on this motherboard</h2>
<p>Doing some research on VFIO compatibility with B550 motherboard seems to show that IOMMU groups aren't good, but I still went with B550 anyways.</p>
<p>Surprise surprise, IOMMU groups were great. The GPU's PCI slot, and 1 of 2 USB controllers is on its own IOMMU group. No ACS patch override needed. (More on USB controller passthrough later)</p>
<h2 id="patched-kernelold-bios-version-unnecessary">Patched kernel/Old BIOS version unnecessary</h2>
<p>Some guides like <a href="https://passthroughpo.st/mac-os-vm-guide-part-2-gpu-passthrough-and-tweaks/">this one from PassthroughPOST</a> seem to suggest that a patched kernel or an old BIOS version is needed to successfully perform GPU passthrough.</p>
<p>As a precaution I did not update my BIOS and GPU passthrough worked. I looked into the BIOS AGESA version and it turned out to be 1.3.0. Updated to the latest version (1.5.0 at this time of writing) and it still works.</p>
<h2 id="gpu-bios-patch">GPU Bios Patch</h2>
<p>joeknock90's guide has included procedures on GPU ROM patching for Nvdia cards, but had stated nothing about AMD cards. Happy to report that AMD does not need to do any ROM patching.</p>
<h2 id="no-need-for-libvirt-hooks">No need for libvirt hooks</h2>
<p>I tried setting up hooks, but there was a 50/50 chance of the script triggering a Segmentation Fault error, causing the whole system to become unresponsive. <a href="https://www.reddit.com/r/VFIO/comments/dc3mu3/rx580_my_experiences_in_passthrough/">This reddit post</a> seem to suggest that did single GPU passthrough with RX580 stated that the hooks were unnecessary. Commented out all the scripts and 10 out of 10 times, the VM boots up successfully.</p>
<h2 id="no-display-manager-just-ensure-xorg-isnt-running">No display manager? Just ensure xorg isn't running</h2>
<p>Most tutorials would suggest killing the display manager but what if you don't use a display manager or desktop environment? If you booted up a graphical interface via xorg (<code>startx</code> command) just make sure its not running or you'll just return to a blank screen when you turn off your VM.</p>
<h2 id="vendor-reset-may-be-needed">vendor-reset may be needed?</h2>
<p><a href="https://www.reddit.com/r/VFIO/comments/jturbd/vendorreset_new_project_to_help_amd_users_vfio/">vendor-reset</a> is a project that aims to help prevent GPU reset issues. I thought it would let me run xorg in the background while running a VM but turns out that's impossible as you can't just suddenly yank the GPU from xorg or it'll crash (thanks <a href="https://www.reddit.com/r/VFIO/comments/5b5znr/click_here_to_join_the_vfio_discord_server/">VFIO Discord</a> for pointing that out!).</p>
<p>Didn't bother removing it so it may or may not have help with the reset bug, I can't really tell.</p>
<h2 id="evdev-only-worked-10-of-the-time-for-my-mouse">evdev only worked 10% of the time for my mouse</h2>
<p>evdev didn't seem to work with my mouse (Logitech MX Master 2) most of the time. Tried all sorts of things (unplug/plug USB etc.) between reboots but no avail. Gave up and used USB passthrough instead. USB passthrough worked great until you need to hotplug a device. So I tried to passthrough one of my USB controllers.</p>
<h2 id="usb-controller-passthrough">USB Controller Passthrough</h2>
<p>It is generally recommended that a dedicated USB PCIe card is used for pass through. Most users that tried passing through the motherboard's built in USB controller seems to have reset issues. Nevertheless I gave it a try and suprisingly works flawlessly, even surviving reboots.</p>
<figure><img src="/uploads/desktop-io.png" alt="I/O layout of an MSI B550 MORTAR WIFI motherboard"><figcaption>On the MSI B550 MORTAR WIFI, red ports are on one USB controller, and the blue ports + front ports are on another controller</figcaption></figure>
<h2 id="first-start-by-running-a-windows-vm">First, start by running a Windows VM</h2>
<p>My ultimate goal is to get a functional macOS build running. But to get a general feel of setting up a VM on linux, it is better to start by getting a working Windows VM.</p>
<p>Windows in a VM is well supported and documented. Few bumps and hiccups along the way (more on that below), but mostly a smooth process.</p>
<h2 id="vfio-drivers-for-windows">VFIO drivers for Windows</h2>
<p>Got the pre-compiled (and signed) VFIO drivers for Windows from Fedora (via the ArchWiki). The ISO download was painfully slow. Fortunately KVM supports floppy disk mounting so I went with the much smaller floppy image instead.</p>
<h2 id="windows-10-ameliorated">Windows 10 Ameliorated</h2>
<p>My plan was to use the Windows VM for only gaming so I thought a stripped down, "clean" version of Windows would be better for my use case. Installed Windows 10 AME but I feel it's too stripped down for me. I think a vanilla Windows 10 install + a <a href="https://github.com/bmrf/tron/blob/master/README.md">debloat script</a> would work better for me.</p>
<h2 id="windows-10-gpu-passthrough">Windows 10 GPU Passthrough</h2>
<p>Passed through the GPU to the Windows 10 VM, installed the latest AMD GPU drivers and fired up Tomb Raider. Cranked it up to max settings and played for a couple of hours. Works flawlessly.</p>
<h2 id="moving-on-to-macos-vm">Moving on to macOS VM</h2>
<p>Time for the main event. There's a couple projects that aims to help easily set up a macOS VM on linux. I tried <a href="https://github.com/foxlet/macOS-Simple-KVM">foxlet's macOS-Simple-KVM</a> project and <a href="https://github.com/kholia/OSX-KVM">kholia's OSX-KVM</a>. Both works great before passing through the GPU.</p>
<h2 id="remember-to-turn-on-csm-in-bios">Remember to turn on CSM in BIOS!</h2>
<p>For weeks I tried to passthrough my GPU to the macOS VM but it just gets stuck in the bootloader. It took too much time so I took a break and tried again. Did a whole lot of googling, and reread all the tutorials/guides that I could find...</p>
<p>Until I came across <a href="https://passthroughpo.st/explaining-csm-efifboff-setting-boot-gpu-manually/">PassthroughPOST's Guide on GPU Passthrough</a>,<br>
and realized that CSM was not enabled. RTFM kids.</p>
<h2 id="vmware-display-device-couldnt-be-turned-off">VMWare display device couldn't be turned off</h2>
<p>OSX-KVM's libvirt XML config came with <code>vmware-svga</code> enabled. Tried to remove it but macOS boots up with a blank screen, even with a GPU vBIOS ROM file configured.</p>
<p>In the end I just left it in, but I could not see the OpenCore menu at all. I just press enter and hope that the macOS login screen appears. Also macOS now thinks there are two different displays connected so I just set them to mirrored displays.</p>
<h2 id="setting-up-imessage">Setting up iMessage</h2>
<p>Followed <a href="https://dortania.github.io/OpenCore-Post-Install/universal/iservices.html">OpenCore's guide</a> to enable iMessage on the VM. Took a huge gamble by activating the VM using my main Apple ID. So far so good, seems to have worked.</p>
<h2 id="handoffcontinuity-in-macos-vm">Handoff/Continuity in macOS VM</h2>
<p>Like with any other hackintoshes, a supported Wifi/BT Broadcom card is needed. The original plan was to get the card + M.2 adapter and pass it through the VM. Unfortunately the adapter's M.2 key is different from what my motherboard supports. Consulting with my motherboard's manual also seem to suggest that the M.2 slots are only for storage devices. Hence this plan is currently on hold.</p>
<h2 id="overall-thoughts">Overall thoughts</h2>
<p>The ability to run any OS is great, it's like having the best of all worlds.<br>
Couple of caveats here and there, but generally speaking works great.<br>
Would only recommend to people who are willing to put time and effort into this.</p><hr/></div><div class="flex flex-col space-y-3 sm:flex-row sm:items-center sm:space-x-5 sm:space-y-0 mt-14 mb-9 font-sans text-base"><div class="w-28 sm:w-32"><img src="/img/avatar.png" srcSet="/assets/avatar@112w.377da505.png 112w, /assets/avatar@128w.9acea303.png 128w" alt="Adwin Ying&#x27;s avatar"/></div><div class="flex flex-1 flex-col space-y-1"><span class="text-2xl font-bold">Adwin Ying</span><p class="text-gray-800">Self-taught full-stack web dev based in Tokyo.<!-- --> <br class="hidden sm:block"/>Occasionally wrecks servers through <a class="text-sky-500 hover:text-sky-700 " href="https://www.reddit.com/r/selfhosted/">self-hosting</a> and <a class="text-sky-500 hover:text-sky-700 " href="https://www.reddit.com/r/homelab/">homelab-ing</a>.</p><div class="flex"><a class="text-sky-500 hover:text-sky-700 flex space-x-1" href="/"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="w-4"><path fill="currentColor" d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"></path></svg><span>https://iAdw.in</span></a></div></div></div><a class="text-sky-500 hover:text-sky-700 font-sans !text-gray-900 underline underline-offset-2" href="/blog">← Back to all posts</a></article><footer class="bg-black py-3 text-center text-gray-50">iAdwin © <!-- -->2022<!-- --> Adwin Ying.</footer>
</body></html>