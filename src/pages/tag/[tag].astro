---
import { getCollection } from "astro:content";

import TagIndex from "@/features/blog/TagIndex";
import BaseLayout from "@/layouts/base.astro";

export async function getStaticPaths() {
  const posts = await getCollection(
    "posts",
    ({ data }) => process.env.NODE_ENV === "development" || !data.draft,
  );
  const tags = [...new Set(posts.map((post) => post.data.tags).flat())];

  return tags.map((tag) => {
    const filteredPosts = posts
      .filter((post) => post.data.tags.includes(tag))
      .map(({ slug, data }) => ({
        title: data.title,
        slug,
        date: data.date,
        tags: data.tags,
      }));

    return {
      params: { tag },
      props: { posts: filteredPosts },
    };
  });
}

interface Props {
  posts: Awaited<ReturnType<typeof getStaticPaths>>[0]["props"]["posts"];
}

const tag = Astro.params.tag ?? "";
const { posts } = Astro.props;
---

<BaseLayout
  title={`Posts Tagged ${tag}`}
  description={`A list of posts that are tagged with ${tag}`}
>
  <TagIndex tag={tag} posts={posts} />
</BaseLayout>
