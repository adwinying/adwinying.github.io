<!DOCTYPE html>
<html lang="en">
<head>
  <title>How to set up Bridge Networking with a Wireless Interface in KVM - iAdwin</title>

<link rel="canonical" href="https://iadw.in/how-to-set-up-bridge-networking-with-a-wireless-interface-in-kvm/">

<meta name="description" content="If you want your VMs to have IP addresses in the same subnet as your local network.">

<meta name="robots" content="index, follow">

<meta property="og:title" content="How to set up Bridge Networking with a Wireless Interface in KVM">
<meta property="og:type" content="article">
<meta property="og:image" content="https://iadw.in/">
<meta property="og:url" content="https://iadw.in/how-to-set-up-bridge-networking-with-a-wireless-interface-in-kvm/">


<meta property="og:description" content="If you want your VMs to have IP addresses in the same subnet as your local network.">






<meta property="og:image:url" content="https://iadw.in/">



<meta property="og:image:height">
<meta property="og:image:alt" content="How to set up Bridge Networking with a Wireless Interface in KVM">


<meta name="twitter:card" content="summary_large_image">




<meta content="width=device-width, initial-scale=1.0" name="viewport"><meta content="Adwin Ying" name="author">


  <meta charSet="UTF-8"/><meta name="theme-color" content="#ffffff"/><link rel="icon" href="/favicon.svg"/><link rel="mask-icon" href="/mask-icon.svg" color="#000000"/><link rel="apple-touch-icon" href="/apple-touch-icon.png"/><link rel="manifest" href="/manifest.json"/><link rel="preconnect" href="https://fonts.googleapis.com"/><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"/><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,500;1,500&amp;family=Open+Sans:ital,wght@0,300;0,400;0,700;1,400;1,700&amp;display=swap"/>

  
<link rel="stylesheet" href="/assets/asset.e11fef85.css"></link>
</head>

<body class="flex flex-col bg-gray-50 min-h-screen ">
  <header class="container mx-auto flex items-center space-x-3 px-5 py-7"><a href="/" class="font-title text-3xl tracking-wider" aria-label="iAdwin">iA</a><span class="h-9 border-r-[2.5px] border-black"></span><a href="/blog" class="font-sans text-3xl font-normal text-gray-900">Blog</a><a href="/blog/rss.xml" target="_parent"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" class="mt-1 h-5"><path fill="currentColor" d="M128.081 415.959c0 35.369-28.672 64.041-64.041 64.041S0 451.328 0 415.959s28.672-64.041 64.041-64.041 64.04 28.673 64.04 64.041zm175.66 47.25c-8.354-154.6-132.185-278.587-286.95-286.95C7.656 175.765 0 183.105 0 192.253v48.069c0 8.415 6.49 15.472 14.887 16.018 111.832 7.284 201.473 96.702 208.772 208.772.547 8.397 7.604 14.887 16.018 14.887h48.069c9.149.001 16.489-7.655 15.995-16.79zm144.249.288C439.596 229.677 251.465 40.445 16.503 32.01 7.473 31.686 0 38.981 0 48.016v48.068c0 8.625 6.835 15.645 15.453 15.999 191.179 7.839 344.627 161.316 352.465 352.465.353 8.618 7.373 15.453 15.999 15.453h48.068c9.034-.001 16.329-7.474 16.005-16.504z"></path></svg></a></header><article class="mx-auto w-full max-w-blog p-5 pb-9"><div class="mb-8 font-sans"><h1 class="mb-1 text-5xl font-bold text-gray-900">How to set up Bridge Networking with a Wireless Interface in KVM</h1><span class="inline-block text-sm text-gray-600">22 Jan 2022 | <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="mr-1 inline-block h-2.5"><path fill="currentColor" d="M0 252.118V48C0 21.49 21.49 0 48 0h204.118a48 48 0 0 1 33.941 14.059l211.882 211.882c18.745 18.745 18.745 49.137 0 67.882L293.823 497.941c-18.745 18.745-49.137 18.745-67.882 0L14.059 286.059A48 48 0 0 1 0 252.118zM112 64c-26.51 0-48 21.49-48 48s21.49 48 48 48 48-21.49 48-48-21.49-48-48-48z"></path></svg><a href="/tag/tutorial" class="text-sm text-gray-600 underline-offset-1 hover:underline ">tutorial</a>, <a href="/tag/kvm" class="text-sm text-gray-600 underline-offset-1 hover:underline ">kvm</a>, <a href="/tag/networking" class="text-sm text-gray-600 underline-offset-1 hover:underline ">networking</a>, <a href="/tag/linux" class="text-sm text-gray-600 underline-offset-1 hover:underline ">linux</a>, <a href="/tag/vfio" class="text-sm text-gray-600 underline-offset-1 hover:underline ">vfio</a>, <a href="/tag/vm" class="text-sm text-gray-600 underline-offset-1 hover:underline ">vm</a></span></div><div class="prose prose-lg max-w-none font-serif
          prose-headings:font-sans
          prose-figcaption:-mt-6 prose-figcaption:text-center
          prose-figcaption:font-sans prose-figcaption:text-sm
          prose-img:mx-auto"><p>By default, KVM sets up a NAT network for guest VMs. This is fine for most use cases, but I wanted to access the guest VMs via my local network. Bridge networks allow guest VMs to obtain an IP address on the local network's subnet, which allows any device on the network to communicate directly with the guest VM.</p>
<p>However, KVM only officially supports bridge networking with <strong>wired interfaces</strong>. For wireless interfaces, a lot of the information is outdated and/or incomplete so here's my take on it. I've mixed and match several sources and managed to get it working.</p>
<h2 id="concept">Concept</h2>
<p>The workaround to creating a bridge network is to use something called Proxy ARP. ARP, in a nutshell, matches IP address with MAC address in your network.</p>
<p>How does ARP works? For example, we have two devices in our network A and B, and A wants to know the MAC address of device B. First, device A will use ARP to query for the MAC address of device B. Then B would respond to the ARP query with its own MAC address.</p>
<p>In the case of Proxy ARP, as the name suggest the ARP response is done by someone else. For this workaround, the host machine will respond to ARP request directed towards the guest machines.</p>
<h2 id="how-to-set-up-bridge-networking">How To Set Up Bridge Networking</h2>
<p>The simplest way to set up bridge networking is via virt-manager. Under <strong>Edit > Connection Details > Virtual Networks</strong> we will add a new virtual network.</p>
<p></p><figure class="remarkri--figure"><picture class="remarkri--picture"><img srcset="/uploads/create-virtual-network-320.png" src="/uploads/create-virtual-network-320.png" alt="Create virtual network dialog" class="remarkri--img" loading="eager"></picture><figcaption class="remarkri--figcaption">Create virtual network dialog</figcaption></figure>
<ul>
<li><strong>Name:</strong> Network name. Put something that you'll be familiar with.</li>
<li><strong>Mode:</strong> Choose <em>Routed</em>.</li>
<li><strong>Forward to:</strong> Choose <em>Physical device..</em></li>
<li><strong>Device:</strong> Input the name of your wireless interface. In my case, my wireless interface is <code>wlo1</code>.</li>
</ul>
<h4 id="ipv4-configuration">IPv4 configuration</h4>
<p>Here, we set the range of IP address the guest OS will receive. Here you should input an IP address range that is same as your local network's subnet. Note that the IP address are assigned by the host machine and not your router. Hence, the IP address listed here should not be in the same range as your router's DHCP address to avoid IP address conflicts.</p>
<p>In my case, my local network's subnet is 192.168.1.x. I then set the range to 192.168.1.90/28, which is between 192.168.1.88 and 192.168.1.94. In my router settings, I set my DHCP address range to between 192.168.1.100 and 192.168.1.254 to avoid conflicts.</p>
<p>For IPv6 configuration and DNS, I left it at default settings.</p>
<p>Click <strong>Finish</strong>, and the virtual network will be created:</p>
<p></p><figure class="remarkri--figure"><picture class="remarkri--picture"><source srcset="/uploads/virt-man-network-interface-640.png" media="(min-width: 640px)"><img srcset="/uploads/virt-man-network-interface-320.png, /uploads/virt-man-network-interface-640.png 2x" src="/uploads/virt-man-network-interface-320.png" alt="proxyArp virtual network created with interface virbr1" class="remarkri--img" loading="eager"></picture><figcaption class="remarkri--figcaption">proxyArp virtual network created with interface virbr1</figcaption></figure>
<h2 id="change-network-interface-for-guest-vm">Change network interface for guest VM</h2>
<p>We then change the network interface for the guest VM. Under virt-manager, we edit the guest VM configuration by selecting the NIC assigned to the guest VM and change the network source to the newly created network bridge interface, in this case <code>virbr1</code>.</p>
<p></p><figure class="remarkri--figure"><picture class="remarkri--picture"><source srcset="/uploads/vm-network-setting-640.png" media="(min-width: 640px)"><img srcset="/uploads/vm-network-setting-320.png, /uploads/vm-network-setting-640.png 2x" src="/uploads/vm-network-setting-320.png" alt="VM network physical interface setting" class="remarkri--img" loading="eager"></picture></figure>
<p>Hit <strong>Apply</strong> to save the configuration.</p>
<h2 id="setting-up-proxy-arp">Setting up proxy ARP</h2>
<p>We need to enable proxy ARP on both the wireless interface and the bridge interface. We do this by using <code>sysctl</code>:</p>
<pre class="astro-code" style="background-color: #2e3440ff; overflow-x: auto;"><code><span class="line"><span style="color: #D8DEE9FF">$ sudo sysctl net.ipv4.conf.wlo1.proxy_arp=1</span></span>
<span class="line"><span style="color: #D8DEE9FF">$ sudo sysctl net.ipv4.conf.virbr1.proxy_arp=1</span></span></code></pre>
<p>Replace <code>wlo1</code> and <code>virbr1</code> with yourr wireless interface and bridge interface respectively.</p>
<h2 id="try-it-out">Try it out!</h2>
<p>Try starting up your VM. If all goes well, your VM will receive an IP address with the same subnet on your local network and working internet connection, and your host's internet will continue to function normally.</p>
<h2 id="persisting-proxy-arp-settings">Persisting proxy ARP settings</h2>
<p>The proxy ARP settings above only takes effect until you reboot your machine. In order to persist the configs, we need to add them into the <code>sysctl</code> config file. In arch linux, we create a file in <code>/etc/sysctl.d/proxy_arp.conf</code>:</p>
<pre class="astro-code" style="background-color: #2e3440ff; overflow-x: auto;"><code><span class="line"><span style="color: #d8dee9ff">net.ipv4.conf.all.proxy_arp=1</span></span>
<span class="line"><span style="color: #d8dee9ff">net.ipv4.conf.wlo1.proxy_arp=1</span></span>
<span class="line"><span style="color: #d8dee9ff">net.ipv4.conf.virbr1.proxy_arp=1</span></span></code></pre>
<h2 id="reference">Reference</h2>
<ul>
<li><a href="https://specman1.wordpress.com/2014/01/02/wireless-bridging-virtual-machines-kvm/" title="https://specman1.wordpress.com/2014/01/02/wireless-bridging-virtual-machines-kvm/">https://specman1.wordpress.com/2014/01/02/wireless-bridging-virtual-machines-kvm/</a></li>
<li><a href="https://unix.stackexchange.com/questions/159191/setup-kvm-on-a-wireless-interface-on-a-laptop-machine" title="https://unix.stackexchange.com/questions/159191/setup-kvm-on-a-wireless-interface-on-a-laptop-machine">https://unix.stackexchange.com/questions/159191/setup-kvm-on-a-wireless-interface-on-a-laptop-machine</a></li>
<li><a href="https://wiki.archlinux.org/title/Sysctl#Configuration" title="https://wiki.archlinux.org/title/Sysctl#Configuration">https://wiki.archlinux.org/title/Sysctl#Configuration</a></li>
</ul>
<p>If this doesn't work for you, try this instead if you have a spare router lying around:</p>
<ul>
<li><a href="https://passthroughpo.st/using-a-spare-router-to-enable-bridged-vm-networking/" title="https://passthroughpo.st/using-a-spare-router-to-enable-bridged-vm-networking/">https://passthroughpo.st/using-a-spare-router-to-enable-bridged-vm-networking/</a></li>
</ul><hr/></div><div class="flex flex-col space-y-3 sm:flex-row sm:items-center sm:space-x-5 sm:space-y-0 mt-14 mb-9 font-sans text-base"><div class="w-28 sm:w-32"><img src="/img/avatar.png" srcSet="/img/avatar.png, /img/avatar-2x.png 2x" alt="Adwin Ying&#x27;s avatar"/></div><div class="flex flex-1 flex-col space-y-1"><span class="text-2xl font-bold">Adwin Ying</span><p class="text-gray-800">Self-taught full-stack web dev based in Tokyo. <br class="hidden sm:block"/>Occasionally wrecks servers through <a class="text-blue-400 hover:text-blue-700 " href="https://www.reddit.com/r/selfhosted/">self-hosting</a> and <a class="text-blue-400 hover:text-blue-700 " href="https://www.reddit.com/r/homelab/">homelab-ing</a>.</p><a class="text-blue-400 hover:text-blue-700 flex space-x-1" href="/"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="w-4"><path fill="currentColor" d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"></path></svg><span>https://iAdw.in</span></a></div></div><a class="text-blue-400 hover:text-blue-700 font-sans !text-gray-900 underline underline-offset-2" href="/blog">← Back to all posts</a></article><footer class="bg-black py-3 text-center text-gray-50">iAdwin © 2021 Adwin Ying.</footer>
</body></html>
